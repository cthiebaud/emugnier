<!DOCTYPE html>

<head>
  <meta charset="utf-8">
  <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">

  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.0-beta1/dist/css/bootstrap.min.css">
  <link rel="preconnect" href="https://fonts.gstatic.com">
  <link href="https://fonts.googleapis.com/css2?family=EB+Garamond&display=swap" rel="stylesheet">
  <style>
    .col {
      border: lightgray solid 1px;
      padding: .5rem;
      display: inline-block;
    }

    /* 
    @font-face {
      font-family: Butterfly;
      src: url("./Butterfly-OVdq8.otf") format("opentype");
    }

    @font-face {
      font-family: 'Courier Prime';
      src: url('./Courier Prime.ttf') format('truetype');
      font-weight: normal;
      font-style: normal;
    }
 */
  </style>
</head>

<body>
  <div class="container-fluid">
    <div>
      <button type="button" class="btn" id="record">Start Recording</button>
      <button type="button" class="btn" id="play" disabled>Play</button>
      <button type="button" class="btn" id="download" disabled>Download</button>
    </div>
    <div class="row row-cols-1 row-cols-sm-2 row-cols-md-3 g-3">
      <div class="col">
        <video id="source" class="img-fluid" controls muted id="bgvid" src="sensation.mp4" type="video/webm">
          <source src="sensation.mp4" type="video/webm">
        </video>
      </div>
      <div class="col">
        <video id="target" class="img-fluid"></video>
      </div>
      <div class="col">
        <canvas id="canvas" class="img-fluid">
        </canvas>
      </div>
    </div>
  </div>
</body>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.0-beta1/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/jquery@latest/dist/jquery.min.js"></script>

<script type="module">

  import { banner as banner } from './modules/banner.js';
  import { main as main } from './main.js';
  import { default as TextDrawer } from './drawText.js';

  const canvas = document.querySelector("canvas");
  const ctx = canvas.getContext("2d");
  const video = document.querySelector("video#source");
  const drawer = TextDrawer(ctx);

  canvas.height = video.videoHeight; // 108*3; // 
  canvas.width = video.videoWidth; // 192*3; // 

  main();

  const poem = [
    "Par les soirs bleus d’é-té, j’i-rai dans les sen-tiers,",
    "Pi-co-té par les blés, fou-ler l’her-be me-nue" + String.fromCharCode(160) + ":",
    "Rê-veur, j’en sen-ti-rai la fraî-cheur à mes pieds.",
    "Je lais-se-rai le vent bai-gner ma tê-te nue.",
  ];
  const c = 9000 / 32;
  const timestamps = [
    0,
    3 * c,
    4 * c,
    6 * c,
    7 * c,
    9 * c,
    12 * c,
    14 * c,
    16 * c,
    20 * c,
    22 * c,
    23 * c,

    9000,
    9000 + 3 * c,
    9000 + 4 * c,
    9000 + 6 * c,
    9000 + 7 * c,
    9000 + 9 * c,
    9000 + 12 * c,
    9000 + 14 * c,
    9000 + 16 * c,
    9000 + 20 * c,
    9000 + 22 * c,
    9000 + 23 * c,

    18000 - 2 * c,
    18000,
    18000 + 4 * c,
    18000 + 6 * c,
    18000 + 7 * c,
    18000 + 9 * c,
    18000 + 12 * c,
    18000 + 14 * c,
    18000 + 16 * c,
    18000 + 20 * c,
    18000 + 22 * c,
    18000 + 23 * c,

    27000,
    27000 + 3 * c,
    27000 + 4 * c,
    27000 + 6 * c,
    27000 + 7 * c,
    27000 + 9 * c,
    27000 + 12 * c,
    27000 + 14 * c,
    27000 + 16 * c,
    27000 + 20 * c,
    27000 + 22 * c,
    27000 + 23 * c,
  ];

  const fadeStart = 36000.0;
  const fadeStop = 40000.0;
  const fadeDuration = fadeStop - fadeStart;

  let tokens = [];
  let count = 0;
  poem.forEach((line, a) => {
    const words = line.split(/ /);
    words.forEach((word, b) => {
      const hyphenizeds = word.split(/[\-]/);
      hyphenizeds.forEach((hyphenized, c) => {
        tokens.push({
          text: hyphenized,
          line: a,
          noSpaceAfter: 0 < hyphenizeds.length && c != hyphenizeds.length - 1,
          threshold: timestamps[count++]
        });
      });
    });
  });

  let i = 0;
  let stop = false;
  let startTime;
  video.addEventListener('play', () => {
    startTime = Date.now();
    stop = false;
    function step() {
      // video
      ctx.drawImage(video, 0, 0);

      // text
      const elapsed = Date.now() - startTime;
      ctx.font = "48px 'EB Garamond'";
      if (fadeStop <= elapsed) {
        if (!stop) {
          requestAnimationFrame(step);
        }
        return;
        /*         
        ctx.strokeStyle = "rgba(0, 0, 0, 0)";
        ctx.fillStyle = "rgba(255, 255, 255, 0)";
        */
      } else if (fadeStart <= elapsed) {
        const opa = ((fadeDuration - (elapsed - fadeStart)) / fadeDuration);
        ctx.strokeStyle = "rgba(0, 0, 0, " + opa + ")";
        ctx.fillStyle = "rgba(255, 255, 255, " + opa + ")";
      } else {
        ctx.strokeStyle = "rgba(0, 0, 0, 1)";
        ctx.fillStyle = "rgba(255, 255, 255, 1)";
      }
      const width = canvas.width;
      const height = canvas.height;
      const xOffsets = poem.map((w) => 0);
      let lastVisibleWord = null;
      let firstInvisibleWord = null;
      const x = 30;
      var fontHeight = parseInt(ctx.font) * 1.2;  // https://stackoverflow.com/a/47725619/1070215
      const getY = (height, size, line) => height - fontHeight * (size - line);
      tokens.forEach((token) => {
        const y = getY(height, poem.length, token.line);
        const thisX = x + xOffsets[token.line];
        xOffsets[token.line] += ctx.measureText(token.text).width;
        if (!token.noSpaceAfter) {
          xOffsets[token.line] += ctx.measureText(String.fromCharCode(160)).width;
        }
        if (token.threshold < elapsed) {
          lastVisibleWord = token;
          lastVisibleWord.offset = xOffsets[token.line];
          drawer.drawShadowedText(token.text, thisX, y, 5);
        } else {
          if (!firstInvisibleWord) {
            firstInvisibleWord = token;
          }
        }
      });
      if (lastVisibleWord && lastVisibleWord.noSpaceAfter) {
        drawer.drawShadowedText("-", x + lastVisibleWord.offset, getY(height, poem.length, lastVisibleWord.line), 5);
        lastVisibleWord.offset += ctx.measureText("-").width;
      }
      // caret
      const showCaret = (firstInvisibleWord && lastVisibleWord && firstInvisibleWord.line != lastVisibleWord.line);
      const caret = "|"; // String.fromCharCode(8248)
      if (showCaret) {
        const blink = Math.round(((elapsed + 300) / 2.) / c);
        // console.log(blink);
        if ((blink % 2) && lastVisibleWord.text != "nue." && firstInvisibleWord) {
          const newLine = (firstInvisibleWord.line != lastVisibleWord.line);
          drawer.drawShadowedText(
            (newLine ? "" : " ") + caret,
            x + (newLine ? 0 : lastVisibleWord.offset),
            getY(height, poem.length, firstInvisibleWord.line));
        }
      } if (!stop) {
        requestAnimationFrame(step);
      }
    }
    requestAnimationFrame(step);
  })

  video.addEventListener('pause', () => {
    stop = true;
  })

  /* $('body').on('click', (e) => console.log(Date.now() - startTime)); */

</script>